<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>æˆ‘ä»¬çš„å°ç§˜å¯† ğŸ’‘ - å®Œæ•´ç‰ˆ</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- PeerJS for è§†é¢‘é€šè¯ -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* ç»ç’ƒå¡ç‰‡ */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* å¤´éƒ¨ */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            background: linear-gradient(45deg, #ff69b4, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(16, 185, 129, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
        }

        /* æ ‡ç­¾é¡µ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 182, 193, 0.5);
            color: white;
            font-weight: 600;
        }

        /* å†…å®¹åŒº */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* äº’åŠ¨æŒ‰é’®ç½‘æ ¼ */
        .interaction-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .interaction-btn {
            aspect-ratio: 1;
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.3), rgba(255, 105, 180, 0.3));
            border: 2px solid rgba(255, 182, 193, 0.5);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .interaction-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 105, 180, 0.3);
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.4), rgba(255, 105, 180, 0.4));
        }

        .interaction-btn .emoji {
            font-size: 36px;
        }

        .interaction-btn .label {
            font-size: 13px;
            color: white;
            font-weight: 600;
        }

        /* è§†é¢‘é€šè¯åŒºåŸŸ */
        .video-container {
            position: relative;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .video-main {
            width: 100%;
            height: 400px;
            object-fit: cover;
            background: #000;
        }

        .video-small {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 200px;
            object-fit: cover;
            border-radius: 15px;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .video-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }

        .video-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .video-btn.call {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .video-btn.hangup {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .video-btn.mute {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .video-btn:hover {
            transform: scale(1.1);
        }

        /* ç•™è¨€è¾“å…¥ */
        .message-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .message-input {
            flex: 1;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            color: white;
            font-size: 15px;
        }

        .message-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .send-btn {
            padding: 15px 25px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            border: none;
            border-radius: 15px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 105, 180, 0.4);
        }

        /* æ¶ˆæ¯åˆ—è¡¨ */
        .messages-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .message-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
        }

        .message-item.mine {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.3), rgba(255, 105, 180, 0.3));
            margin-left: 30px;
        }

        .message-item.theirs {
            background: rgba(255, 255, 255, 0.15);
            margin-right: 30px;
        }

        .message-sender {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }

        .message-text {
            color: white;
            font-size: 15px;
            line-height: 1.5;
        }

        .message-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: rgba(255, 255, 255, 0.6);
        }

        .empty-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        /* é€šçŸ¥å¼¹çª— */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* åœ¨çº¿çŠ¶æ€ */
        .online-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(16, 185, 129, 0.2);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            color: #10b981;
            margin-top: 10px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* å¿ƒè·³åŠ¨ç”» */
        .heartbeat {
            animation: heartbeat 1.5s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            10%, 30% { transform: scale(0.9); }
            20%, 40% { transform: scale(1.1); }
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .interaction-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .video-main {
                height: 300px;
            }

            .video-small {
                width: 100px;
                height: 133px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="glass-card">
            <div class="header">
                <h1>ğŸ’‘ æˆ‘ä»¬çš„å°ç§˜å¯† ğŸ’‘</h1>
                <div class="sync-status">
                    <div class="sync-dot"></div>
                    <span>å®æ—¶åŒæ­¥ä¸­</span>
                </div>
                <div class="online-status" id="onlineStatus">
                    <div class="online-dot"></div>
                    <span>æ­£åœ¨æ£€æµ‹å¯¹æ–¹çŠ¶æ€...</span>
                </div>
            </div>

            <!-- æ ‡ç­¾é¡µ -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('interactions')">
                    ğŸ’• äº’åŠ¨
                </div>
                <div class="tab" onclick="switchTab('messages')">
                    ğŸ’¬ ç•™è¨€
                </div>
                <div class="tab" onclick="switchTab('video')">
                    ğŸ“¹ è§†é¢‘
                </div>
                <div class="tab" onclick="switchTab('records')">
                    ğŸ“… è®°å½•
                </div>
            </div>

            <!-- äº’åŠ¨æ ‡ç­¾é¡µ -->
            <div id="interactions" class="tab-content active">
                <h3 style="color: white; margin-bottom: 20px; font-size: 18px;">ğŸ’ æƒ…ä¾£äº’åŠ¨</h3>
                
                <div class="interaction-grid">
                    <div class="interaction-btn" onclick="sendInteraction('kiss', 'ğŸ’‹ é£å»')">
                        <div class="emoji">ğŸ’‹</div>
                        <div class="label">é£å»</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('hug', 'ğŸ¤— æŠ±æŠ±')">
                        <div class="emoji">ğŸ¤—</div>
                        <div class="label">æŠ±æŠ±</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('love', 'â¤ï¸ çˆ±ä½ ')">
                        <div class="emoji heartbeat">â¤ï¸</div>
                        <div class="label">çˆ±ä½ </div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('miss', 'ğŸ¥º æƒ³ä½ ')">
                        <div class="emoji">ğŸ¥º</div>
                        <div class="label">æƒ³ä½ </div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('rose', 'ğŸŒ¹ é€èŠ±')">
                        <div class="emoji">ğŸŒ¹</div>
                        <div class="label">é€èŠ±</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('gift', 'ğŸ ç¤¼ç‰©')">
                        <div class="emoji">ğŸ</div>
                        <div class="label">ç¤¼ç‰©</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('breakfast', 'ğŸ³ åšæ—©é¤')">
                        <div class="emoji">ğŸ³</div>
                        <div class="label">åšæ—©é¤</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('massage', 'ğŸ’† æŒ‰æ‘©')">
                        <div class="emoji">ğŸ’†</div>
                        <div class="label">æŒ‰æ‘©</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('movie', 'ğŸ¬ çœ‹ç”µå½±')">
                        <div class="emoji">ğŸ¬</div>
                        <div class="label">çœ‹ç”µå½±</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('walk', 'ğŸš¶ æ•£æ­¥')">
                        <div class="emoji">ğŸš¶</div>
                        <div class="label">æ•£æ­¥</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('coffee', 'â˜• å–å’–å•¡')">
                        <div class="emoji">â˜•</div>
                        <div class="label">å–å’–å•¡</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('sleep', 'ğŸ˜´ æ™šå®‰')">
                        <div class="emoji">ğŸ˜´</div>
                        <div class="label">æ™šå®‰</div>
                    </div>
                </div>

                <h3 style="color: white; margin: 30px 0 20px 0; font-size: 18px;">ğŸ¯ å¿«é€Ÿå…³æ€€</h3>
                
                <div class="interaction-grid">
                    <div class="interaction-btn" onclick="sendInteraction('water', 'ğŸ’§ å¤šå–æ°´')">
                        <div class="emoji">ğŸ’§</div>
                        <div class="label">å¤šå–æ°´</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('rest', 'ğŸ˜Œ ä¼‘æ¯ä¸‹')">
                        <div class="emoji">ğŸ˜Œ</div>
                        <div class="label">ä¼‘æ¯ä¸‹</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('eat', 'ğŸ± è®°å¾—åƒé¥­')">
                        <div class="emoji">ğŸ±</div>
                        <div class="label">åƒé¥­</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('weather', 'ğŸŒ¡ï¸ æ³¨æ„å¤©æ°”')">
                        <div class="emoji">ğŸŒ¡ï¸</div>
                        <div class="label">å¤©æ°”</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('safety', 'ğŸ  æ³¨æ„å®‰å…¨')">
                        <div class="emoji">ğŸ </div>
                        <div class="label">å®‰å…¨</div>
                    </div>
                    <div class="interaction-btn" onclick="sendInteraction('cheer', 'ğŸ’ª åŠ æ²¹')">
                        <div class="emoji">ğŸ’ª</div>
                        <div class="label">åŠ æ²¹</div>
                    </div>
                </div>

                <!-- æœ€è¿‘äº’åŠ¨è®°å½• -->
                <div style="margin-top: 30px;">
                    <h3 style="color: white; margin-bottom: 15px; font-size: 16px;">ğŸ“Š æœ€è¿‘äº’åŠ¨</h3>
                    <div id="recentInteractions" style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">
                        æš‚æ— äº’åŠ¨è®°å½•
                    </div>
                </div>
            </div>

            <!-- ç•™è¨€æ ‡ç­¾é¡µ -->
            <div id="messages" class="tab-content">
                <div class="message-input-container">
                    <input 
                        type="text" 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="ç»™taç•™ä¸ªè¨€å§~ ğŸ’•"
                        maxlength="200"
                    >
                    <button class="send-btn" onclick="sendMessage()">
                        å‘é€
                    </button>
                </div>

                <div class="messages-list" id="messagesList">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ’Œ</div>
                        <div>è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«æ¥è¯´ç‚¹ä»€ä¹ˆå§~</div>
                    </div>
                </div>
            </div>

            <!-- è§†é¢‘é€šè¯æ ‡ç­¾é¡µ -->
            <div id="video" class="tab-content">
                <div class="video-container" id="videoContainer" style="display: none;">
                    <video id="remoteVideo" class="video-main" autoplay playsinline></video>
                    <video id="localVideo" class="video-small" autoplay playsinline muted></video>
                    
                    <div class="video-controls">
                        <button class="video-btn mute" onclick="toggleMute()" title="é™éŸ³/å–æ¶ˆé™éŸ³">
                            ğŸ¤
                        </button>
                        <button class="video-btn hangup" onclick="hangUp()" title="æŒ‚æ–­">
                            ğŸ“
                        </button>
                    </div>
                </div>

                <div id="callInterface">
                    <div style="text-align: center; padding: 30px 20px;">
                        <div style="font-size: 80px; margin-bottom: 20px;">ğŸ“¹</div>
                        <div style="color: white; font-size: 18px; margin-bottom: 30px;">
                            è§†é¢‘é€šè¯
                        </div>
                        <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 25px; line-height: 1.8;">
                            ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®å¼€å§‹è§†é¢‘é€šè¯<br>
                            å¯¹æ–¹ä¼šæ”¶åˆ°é€šè¯è¯·æ±‚
                        </div>
                        <button class="video-btn call" onclick="startCall()" style="width: 80px; height: 80px; font-size: 30px;">
                            ğŸ“
                        </button>
                        <div style="margin-top: 20px; font-size: 13px; color: rgba(255, 255, 255, 0.6);">
                            æç¤ºï¼šéœ€è¦å…è®¸æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™
                        </div>
                    </div>
                </div>
            </div>

            <!-- è®°å½•æ ‡ç­¾é¡µ -->
            <div id="records" class="tab-content">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“…</div>
                    <div>è®°å½•åŠŸèƒ½å¼€å‘ä¸­...</div>
                    <div style="font-size: 13px; margin-top: 10px;">
                        å°†åŒ…å«ç”Ÿç†æœŸè®°å½•ã€çºªå¿µæ—¥ç­‰åŠŸèƒ½
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAfJlwD2WNyEjWi9P_xtyIJgPd8mkf0fJQ",
            authDomain: "our-secret-172a7.firebaseapp.com",
            databaseURL: "https://our-secret-172a7-default-rtdb.firebaseio.com",
            projectId: "our-secret-172a7",
            storageBucket: "our-secret-172a7.firebasestorage.app",
            messagingSenderId: "370805742187",
            appId: "1:370805742187:web:031b2a39cf42d5dd6d6f2e"
        };

        // åˆå§‹åŒ–
        let db, coupleId, userId;
        let peer, localStream, remoteStream;
        let currentCall = null;
        let isMuted = false;

        // é¡µé¢åŠ è½½
        window.onload = function() {
            // åˆå§‹åŒ– Firebase
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();

            // è·å–é…ç½®
            coupleId = localStorage.getItem('coupleId');
            if (!coupleId) {
                alert('è¯·å…ˆé…ç½®ä¸“å±IDï¼');
                window.location.href = 'firebase-sync-test.html';
                return;
            }

            // ç”Ÿæˆç”¨æˆ·ID
            userId = localStorage.getItem('userId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
            }

            // åˆå§‹åŒ–åŠŸèƒ½
            initOnlineStatus();
            loadMessages();
            loadInteractions();
            initVideoCall();
        };

        // === æ ‡ç­¾é¡µåˆ‡æ¢ ===
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰active
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // æ·»åŠ active
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // === åœ¨çº¿çŠ¶æ€ ===
        function initOnlineStatus() {
            const onlineRef = db.ref(`couples/${coupleId}/online/${userId}`);
            const partnerRef = db.ref(`couples/${coupleId}/online`);

            // è®¾ç½®è‡ªå·±åœ¨çº¿
            onlineRef.set({
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                userId: userId
            });

            // æ–­çº¿æ—¶ç§»é™¤
            onlineRef.onDisconnect().remove();

            // ç›‘å¬å¯¹æ–¹çŠ¶æ€
            partnerRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const partners = Object.keys(data).filter(id => id !== userId);
                    if (partners.length > 0) {
                        updateOnlineStatus(true);
                    } else {
                        updateOnlineStatus(false);
                    }
                } else {
                    updateOnlineStatus(false);
                }
            });

            // å®šæœŸæ›´æ–°
            setInterval(() => {
                onlineRef.set({
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userId: userId
                });
            }, 30000);
        }

        function updateOnlineStatus(isOnline) {
            const statusEl = document.getElementById('onlineStatus');
            if (isOnline) {
                statusEl.innerHTML = '<div class="online-dot"></div><span>Taåœ¨çº¿ â¤ï¸</span>';
                statusEl.style.background = 'rgba(16, 185, 129, 0.2)';
                statusEl.style.color = '#10b981';
            } else {
                statusEl.innerHTML = '<div class="online-dot" style="background: #999; animation: none;"></div><span>Taç¦»çº¿</span>';
                statusEl.style.background = 'rgba(156, 163, 175, 0.2)';
                statusEl.style.color = '#9ca3af';
            }
        }

        // === äº’åŠ¨åŠŸèƒ½ ===
        function sendInteraction(type, label) {
            const interactionRef = db.ref(`couples/${coupleId}/interactions`).push();
            interactionRef.set({
                type: type,
                label: label,
                from: userId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                showNotification(`å·²å‘é€ï¼š${label} ğŸ’•`);
            });
        }

        function loadInteractions() {
            const interactionsRef = db.ref(`couples/${coupleId}/interactions`).limitToLast(10);
            interactionsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                const interactions = Object.values(data).reverse();
                const html = interactions.map(item => {
                    const time = new Date(item.timestamp).toLocaleTimeString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const who = item.from === userId ? 'ä½ ' : 'Ta';
                    return `<div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        ${item.label} Â· ${who} Â· ${time}
                    </div>`;
                }).join('');

                document.getElementById('recentInteractions').innerHTML = html;
            });
        }

        // === ç•™è¨€åŠŸèƒ½ ===
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text) {
                alert('è¯·è¾“å…¥ç•™è¨€å†…å®¹');
                return;
            }

            const messageRef = db.ref(`couples/${coupleId}/messages`).push();
            messageRef.set({
                text: text,
                from: userId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                input.value = '';
                showNotification('ç•™è¨€å·²å‘é€ ğŸ’Œ');
            });
        }

        function loadMessages() {
            const messagesRef = db.ref(`couples/${coupleId}/messages`).limitToLast(50);
            messagesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const listEl = document.getElementById('messagesList');

                if (!data) {
                    listEl.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ’Œ</div><div>è¿˜æ²¡æœ‰ç•™è¨€</div></div>';
                    return;
                }

                const messages = Object.values(data);
                const html = messages.map(msg => {
                    const isMine = msg.from === userId;
                    const time = new Date(msg.timestamp).toLocaleString('zh-CN', {
                        month: 'numeric',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    return `<div class="message-item ${isMine ? 'mine' : 'theirs'}">
                        <div class="message-sender">${isMine ? 'æˆ‘' : 'Ta'}</div>
                        <div class="message-text">${msg.text}</div>
                        <div class="message-time">${time}</div>
                    </div>`;
                }).join('');

                listEl.innerHTML = html;
                listEl.scrollTop = listEl.scrollHeight;
            });
        }

        // === è§†é¢‘é€šè¯åŠŸèƒ½ ===
        function initVideoCall() {
            // åˆå§‹åŒ– PeerJS
            peer = new Peer(userId, {
                host: 'peerjs-server.herokuapp.com',
                secure: true,
                port: 443
            });

            peer.on('open', (id) => {
                console.log('PeerJS ID:', id);
                // æ›´æ–°è‡ªå·±çš„ Peer ID
                db.ref(`couples/${coupleId}/peerIds/${userId}`).set(id);
            });

            // æ¥æ”¶é€šè¯
            peer.on('call', (call) => {
                if (confirm('Taæƒ³å’Œä½ è§†é¢‘é€šè¯ï¼Œæ¥å¬å—ï¼ŸğŸ’•')) {
                    answerCall(call);
                } else {
                    call.close();
                }
            });

            peer.on('error', (err) => {
                console.error('PeerJS Error:', err);
            });
        }

        async function startCall() {
            try {
                // è·å–æœ¬åœ°åª’ä½“æµ
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                document.getElementById('localVideo').srcObject = localStream;

                // è·å–å¯¹æ–¹çš„ Peer ID
                const snapshot = await db.ref(`couples/${coupleId}/peerIds`).once('value');
                const peerIds = snapshot.val();
                const partnerIds = Object.keys(peerIds).filter(id => id !== userId);

                if (partnerIds.length === 0) {
                    alert('å¯¹æ–¹ä¸åœ¨çº¿ï¼Œæ— æ³•å‘èµ·é€šè¯');
                    stopLocalStream();
                    return;
                }

                const partnerId = peerIds[partnerIds[0]];

                // å‘èµ·é€šè¯
                currentCall = peer.call(partnerId, localStream);

                currentCall.on('stream', (remoteStream) => {
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                    showVideoUI();
                    showNotification('é€šè¯å·²æ¥é€š ğŸ“');
                });

                currentCall.on('close', () => {
                    hangUp();
                });

            } catch (err) {
                console.error('è·å–åª’ä½“å¤±è´¥:', err);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´/éº¦å…‹é£\n\nè¯·ç¡®ä¿å·²æˆäºˆæƒé™ï¼');
            }
        }

        async function answerCall(call) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                document.getElementById('localVideo').srcObject = localStream;

                call.answer(localStream);
                currentCall = call;

                call.on('stream', (remoteStream) => {
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                    showVideoUI();
                    showNotification('é€šè¯å·²æ¥é€š ğŸ“');
                });

                call.on('close', () => {
                    hangUp();
                });

            } catch (err) {
                console.error('æ¥å¬å¤±è´¥:', err);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´/éº¦å…‹é£');
            }
        }

        function hangUp() {
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }

            stopLocalStream();
            hideVideoUI();
            showNotification('é€šè¯å·²ç»“æŸ');
        }

        function stopLocalStream() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
        }

        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                isMuted = !audioTrack.enabled;

                const btn = event.target.closest('.video-btn');
                btn.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ¤';
            }
        }

        function showVideoUI() {
            document.getElementById('callInterface').style.display = 'none';
            document.getElementById('videoContainer').style.display = 'block';
        }

        function hideVideoUI() {
            document.getElementById('callInterface').style.display = 'block';
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
        }

        // === é€šçŸ¥ ===
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // è¾“å…¥æ¡†å›è½¦å‘é€
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('messageInput');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        });
    </script>
</body>
</html>
